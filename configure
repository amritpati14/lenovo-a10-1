#!/usr/bin/env bash


# ******************  Any error is a bad error. Die immediately

set -e

SUCCESS=N

function finish {
	if [ "z${SUCCESS}" != "zY" ]; then
		echo -n "ERROR: please try again. Dunno what went wrong. Maybe use"
		echo " relative or actual paths. ie: be specific"
		exit -1
	fi;
}

trap finish EXIT


# ****************** Load up configurations

BASE=$(readlink -f `dirname $0`)
BUILD=$(readlink -f `pwd`)


RELPATH=$(realpath --relative-to=${HOME}/src/lenovoa10 ${BASE})

CONFFILE=${RELPATH}/configure
MAKEFILE=${RELPATH}/Makefile


if [ "${BASE}" == "${BUILD}" ]; then


	echo "**************************************************"
	echo
	echo "NO! Not here!"
	echo

	echo -n "You need to go create a build directory in "
	echo -n "which we can work and then call this script from there. "
	echo "So, for example, do this:"
	echo
	echo "     bash# mkdir -p \${HOME}/src/lenovoa10"
	echo "     bash# cd \${HOME}/src/lenovoa10"
	echo "     bash# ${CONFFILE}"
	echo

	exit;

fi


cp -f ${MAKEFILE} ./Makefile

rm -f ./config ./config.tmp

echo -n "# Generated by the configure script at " > ./config.tmp
date >> ./config.tmp
echo >> ./config.tmp
echo >> ./config.tmp
echo "BASE=${BASE}" >> ./config.tmp
echo "BUILD=${BUILD}" >> ./config.tmp


# ------------------------------------------------------------------

DEF=\${HOME}/.lenovoa10/src

echo "QUESTION 1. Where do you want to store downloaded packages?"
echo
echo -n "If you plan to have multiple builds, try use a nice common path"
echo -n " like this default. This will save you bandwidth and time from"
echo " redownloading the sources."
echo
echo -n "(default = ${DEF}) ? "
read -r SRCDIR
SRCDIR=${SRCDIR:-${DEF}}
SRCDIR=$(eval echo -n ${SRCDIR})
mkdir -p ${SRCDIR}
SRCDIR=$(readlink -f ${SRCDIR})
echo "SRCDIR=${SRCDIR}" >> ./config.tmp


# ------------------------------------------------------------------


echo "QUESTION 2. Which system do you want?"
echo
echo "1 - Lenovo 3.0.36"
echo "2 - Linux stock 4.9.0"
echo
echo -n "(default = 1) ? "
read -r KCHOICE

KCHOICE=${KCHOICE:-1}

if [ "z${KCHOICE}" != "z1" -a "z${KCHOICE}" != "z2" ]; then
	echo "Either 1 or 2. Nothing else works."
	exit 1
fi;


if [ "z${KCHOICE}" == "z1" ]; then
	cat ${BASE}/extconfigs/system-3.0.36 >>  ./config.tmp
elif [ "z${KCHOICE}" == "z2" ]; then
	cat ${BASE}/extconfigs/system-4.9.0 >>  ./config.tmp
fi




# ------------------------------------------------------------------


mv -f ./config.tmp ./config

echo
echo
echo "---------  ./config  --------"
cat ./config
echo "-----------------------------"
echo

SUCCESS=Y


echo
echo "Ready for make"


